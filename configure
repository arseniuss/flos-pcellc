#!/bin/sh

# when any command fails, the shell immediately exists
set -e

progname="$0"

. ./config.inc

do_local_setup=0
on_exit_cmd=""

trap 'excode=$?; if [ $excode != 0 ]; then rm -f config.mk; fi' EXIT INT HUP

setvar() {
    local name="$1"
    local defval="$2"

    ! test -z "$(eval echo \$$name)" && eval export $name || eval export $name=\"$defval\"
}

setechovar() {
    setvar "$1" "$2"
    eval echo \"\$$1\"
}

prefix() {
	local prefix="$1 "

	[ -z "$prefix" ] && prefix=$PREFIX

	while IFS= read line
	do
		echo "$prefix$line"
	done
}

make_local() {
    local name="$1"
    local location="$2"
    local includes="$3"
    local libs="$4"

    (
        cd "$location";

        if [ ! -f config.mk ]; then
            echo "Configuring $name ..."
            ./configure $includes $libs || rm -f config.mk
        fi
        make
    )
}

setup_local() {
    local includes=""

    DEPLIBS_COUNT=$(echo "$DEPLIBS" | wc -w)

    mkdir -p deps

    i=0
    while [ "$i" -lt $DEPLIBS_COUNT ]; do
        i=$(( i + 1 ))

        name=$(echo "$DEPLIBS" | cut -d\  -f$i)
        echo "Setting dependency library $name ..."

        url=$(eval echo \"\$${name}_URL\")
        if [ -z "$url" ]; then
            echo "error: URL is not set for library $name" > /dev/stderr
            continue
        fi

        dir=$(eval echo \"\$${name}_DIR\")
        if [ -z "$dir" ]; then
            echo "error: archive directory is not set for library $name" > /dev/stderr
            continue
        fi

        if [ ! -f deps/$name.zip ]; then
            echo "Downloading $name.zip ..."

            wget -nc "$url" -P deps -O deps/$name.zip 2>&1 | prefix "[$name wget]" || true
        fi

        if [ ! -d deps/$dir/ ]; then
            echo "Unzipping $name ..."

            mkdir deps/$dir/
            unzip -q deps/$name.zip -d deps 2>&1 | prefix "[$name unzip]"
        fi

        make_local "$name" "deps/$dir/" "$includes" "$libs" | prefix "[$name make]"

        if [ -d deps/$dir/include ]; then
            includes="$includes ${name}_INCLUDE=../$dir/include"
        fi

        if [ -d deps/$dir/lib ]; then
            libs="$libs ${name}_LIB=../$dir/lib"
        fi
    done
}

setup_deps() {
    local config_file="$1"

    DEPLIBS_COUNT=$(echo "$DEPLIBS" | wc -w)

    i=0
    while [ "$i" -lt $DEPLIBS_COUNT ]; do
        i=$(( i + 1 ))

        name=$(echo "$DEPLIBS" | cut -d\  -f$i)

        if [ "$do_local_setup" -eq 1 ]; then
            dir=$(eval echo \"\$${name}_DIR\")

            [ -z "$dir" ] && continue;

            if [ -d deps/$dir/include ]; then
                echo "${name}_INCLUDE=deps/$dir/include" >> $config_file
            fi

            if [ -d deps/$dir/lib ]; then
                echo "${name}_LIB=deps/$dir/lib" >> $config_file
            fi
        else
            include=$(eval echo "\${${name}_INCLUDE}")
            if [ -z "$include" ]; then
                echo "${name}_INCLUDE is not set" > /dev/stderr
                exit 1
            fi
            echo "${name}_INCLUDE=$include" >> $config_file

            lib=$(eval echo "\${${name}_LIB}")
            if [ -z "$lib" ]; then
                echo "${name}_LIB is not set" > /dev/stderr
                exit 1
            fi
            echo "${name}_LIB=$lib" >> $config_file
        fi
    done  
}

while [ $# -gt 0 ]; do
    case "$1" in
    --local)
        do_local_setup=1
        ;;
    --srcdir=*)
        srcdir="${1#*=}"
        ;;
    --prefix=*)
        prefix="${1#*=}"
        ;;
    --exec-prefix=*)
        exec_prefix="${1#*=}"
        ;;
    --bindir=*)
        bindir="${1#*=}"
        ;;
    --sbindir=*)
        sbindir="${1#*=}"
        ;;
    --sysconfdir=*)
        sysconfdir="${1#*=}"
        ;;
    --localstatedir=*)
        localstatedir="${1#*=}"
        ;;
    --runstatedir=*)
        runstatedir="${1#*=}"
        ;;
    --libdir=*)
        libdir="${1#*=}"
        ;;
    --includedir=*)
        includedir="${1#*=}"
        ;;
    --datarootdir=*)
        datarootdir="${1#*=}"
        ;;
    --datadir=*)
        datadir="${1#*=}"
        ;;
    --docdir=*)
        docdir="${1#*=}"
        ;;

    *=*)
        eval ${1%%=*}=\"${1#*=}\"
        ;;
    --*|-*)
        printf "%s: illegal option: %s\n" "$progname" "$1"
        exit 1
        ;;
    *)
        printf "%s: unrecognised argument: %s\n" "$progname" "$1"
        exit 1
        ;;
    esac
    shift
done

#
# Base directories
#
setvar srcdir .
setvar prefix .
setvar exec_prefix "$prefix"
setvar datarootdir "$prefix/share"
setvar CFLAGS "-Wall -Wshadow -Wextra"
setvar LDFLAGS
setvar LIBS
setvar INCLUDES

# Append defaults
CFLAGS="$CFLAGS -std=c99 -DVERSION=\"$version\""
LDFLAGS="$LDFLAGS "

if [ "$do_local_setup" -eq 1 ]; then
    setup_local
fi

cat <<EOF > $srcdir/config.mk
#
# Autogenerated by $progname script
#

PACKAGE = $package
VERSION = $version

AR = $(setechovar AR ar)
CC = $(setechovar CC cc)
COV = $(setechovar COV gcov)
LD = $(setechovar LD cc)
PP = $(setechovar PP cpp)
PROVE = $(setechovar PROVE prove)

CFLAGS = $CFLAGS
LDFLAGS = $LDFLAGS
LIBS = $LIBS

EOF

setup_deps "$srcdir/config.mk"

cat<<EOF >> $srcdir/config.mk

root = $(setechovar ROOT /)

srcdir = $(setechovar srcdir .)
builddir = $(setechovar builddir build)

prefix = $prefix
exec_prefix = $exec_prefix

bindir = $(setechovar bindir "$exec_prefix/bin")
sbindir = $(setechovar sbindir "$exec_prefix/sbin")
sysconfdir = $(setechovar sysconfdir "$prefix/etc")
localstatedir = $(setechovar localstatedir "$prefix/var")
runstatedir = $(setechovar runstatedir "$prefix/run")
libdir = $(setechovar libdir "$exec_prefix/lib")
includedir = $(setechovar includedir "$prefix/include")
datarootdir = $datarootdir
datadir = $(setechovar datadir "$datarootdir")
docdir = $(setechovar docdir "$datarootdir/doc/$package")
EOF
